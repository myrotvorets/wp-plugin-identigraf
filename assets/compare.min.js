(()=>{function e(t){var s=n[t];if(void 0!==s)return s.exports;var o=n[t]={exports:{}};return r[t](o,o.exports,e),o.exports}var t,r={8486:(e,t,r)=>{function n({progress:e}){return null==e?null:i().createElement("div",{className:"d-flex align-items-center mb-3"},(0,g.__)("Upload:","i8fjs"),i().createElement(E.Z,{now:-1===e?100:e,striped:-1===e,animated:!0,className:"flex-fill mx-1"}),-1!==e?i().createElement("span",null,e.toFixed(2),"%"):void 0)}function s(e){const t=y[e.code];return null!=t?t:e.message}function o(){return i().createElement(S.Z,null,i().createElement(S.Z.Header,null,(0,g.__)("Processing the request","i8fjs")),i().createElement(S.Z.Body,null,i().createElement(S.Z.Title,null,(0,g.__)("Please waitâ€¦","i8fjs")),i().createElement(E.Z,{now:100,striped:!0,animated:!0})))}var a=r(7363),i=r.n(a),l=r(1533),c=r(754),u=r(1262),h=r(8662),m=r(4289),d=r(9635);const p=i().createContext({token:""});var f=r(2568),_=r(7137);const g=wp.i18n;var E=r(6364);const v=wp.apiFetch;var b=r.n(v);const y={AUTHORIZATION_FAILED:(0,g.__)("Authorization failed.","i8fjs"),AUTHORIZATION_REQUIRED:(0,g.__)("Not authorized to perform this action.","i8fjs"),BAD_GATEWAY:(0,g.__)("Error communicating with the server.","i8fjs"),COMM_ERROR:(0,g.__)("Error communicating with the server.","i8fjs"),UNKNOWN_ERROR:(0,g.__)("Unknown error.","i8fjs")};class j{static getApiToken(){return b()({path:"/identigraf/v2/token"}).then((e=>e.token)).catch((()=>{throw new Error((0,g.__)("Error getting the authentication token","i8fjs"))}))}static checkCompareStatus(e,t){return j.get(`/compare/${e}`,t)}static checkSearchStatus(e,t){return j.get(`/search/${e}`,t)}static getMatchedFaces(e,t,r){return j.get(`/search/${e}/matches/${t}/0/20`,r)}static get(e,t){return j.fetch(`${self.i8f.endpoint}${e}`,{headers:{Accept:"application/json",Authorization:`Bearer ${t}`}})}static fetch(e,t){return fetch(e,t).then((e=>e.json())).catch(j.error502)}static error502(){return{success:!1,status:502,code:"COMM_ERROR",message:(0,g.__)("Error communicating with the server","i8fjs")}}}class k extends a.Component{constructor(...e){super(...e),this.state={error:null,uploadProgress:null,hasPhoto1:!1,hasPhoto2:!1,guid:null},this._onFileChange=({currentTarget:e})=>{const{files:t,id:r}=e,n=null!==t&&t.length>0;this.setState("photo1"===r?{hasPhoto1:n}:{hasPhoto2:n})},this._onFormSubmit=e=>{e.preventDefault();const t=new FormData(e.currentTarget);this.setState({uploadProgress:0,error:null});const r=new XMLHttpRequest;r.upload.addEventListener("progress",this._onUploadProgress),r.addEventListener("error",this._onUploadFailed),r.addEventListener("abort",this._onUploadAborted),r.addEventListener("timeout",this._onUploadTimeout),r.addEventListener("load",this._onUploadSucceeded),r.open("POST",`${self.i8f.endpoint}/compare`),r.setRequestHeader("Authorization",`Bearer ${this.context.token}`),r.send(t)},this._onUploadProgress=e=>{let t;t=e.lengthComputable?e.loaded/e.total*100:-1,this.setState({uploadProgress:t})},this._onUploadFailed=()=>{this._setError((0,g.__)("Failed to upload the file","i8fjs"))},this._onUploadTimeout=()=>{this._setError((0,g.__)("Request has timed out","i8fjs"))},this._onUploadAborted=()=>{this._setError((0,g.__)("Upload aborted","i8fjs"))},this._onUploadSucceeded=e=>{this.setState({uploadProgress:100});const t=e.currentTarget;try{const e=JSON.parse(t.responseText);e.success?this.setState({guid:e.guid}):this._setError(401===t.status?(0,g.__)("Unexpected authentication error","i8fjs"):s(e))}catch(e){this._setError((0,g.__)("Unknown error while analyzing the server response","i8fjs"))}}}_setError(e){this.setState({uploadProgress:null,error:e})}render(){const{error:e,guid:t,uploadProgress:r}=this.state;return null!==t?i().createElement(d.l_,{to:`/compare/${t}`}):i().createElement(f.Z,{onSubmit:this._onFormSubmit,encType:"multipart/form-data"},e&&i().createElement(u.Z,{variant:"danger"},e),i().createElement(f.Z.Group,{controlId:"photo",className:"mb-3"},i().createElement(f.Z.Label,null,(0,g.__)("Compared photo","i8fjs")),i().createElement(f.Z.Control,{name:"photos",type:"file",required:!0,accept:"image/png, image/jpeg",disabled:null!==r,onChange:this._onFileChange})),i().createElement(f.Z.Group,{controlId:"photo2",className:"mb-3"},i().createElement(f.Z.Label,null,(0,g.__)("Reference photos (up to 10 files)","i8fjs")),i().createElement(f.Z.Control,{name:"photos",type:"file",required:!0,multiple:!0,accept:"image/png, image/jpeg",disabled:null!==r,onChange:this._onFileChange,"aria-describedby":"uploadHelpBlock"})),i().createElement(n,{progress:r}),i().createElement(_.Z,{variant:"primary",type:"submit"},(0,g.__)("Submit","i8fjs")))}}k.contextType=p;var T=r(9638),S=r(1325),x=r(2252);class Z extends a.Component{constructor(...e){super(...e),this.state={state:"check",error:"",results:{},numFiles:0},this._timerId=null,this._checkStatus=()=>{this._timerId=null;const{guid:e}=this.props;j.checkCompareStatus(e,this.context.token).then((e=>(e.success?"inprogress"===e.status?this._timerId=self.setTimeout(this._checkStatus,1e3):this.setState({state:"complete"===e.status?"done":"nofaces",results:e.matches,numFiles:e.numFiles}):this.setState({state:"done",error:s(e)}),null)))},this._renderPhoto=(e,t)=>{const{guid:r}=this.props;return i().createElement(T.Z.Item,{key:t},i().createElement("img",{className:"img-fluid d-block mx-auto",src:`https://api2.myrotvorets.center/identigraf-upload/v1/get/${r}/${t+1}`,alt:(0,g.sprintf)((0,g.__)("Photo %1$d","i8fjs"),t+1),style:{maxHeight:"40vh"}}),i().createElement(T.Z.Caption,null,i().createElement("strong",null,(0,g.__)("Similarity:","i8fjs"))," ",e,"%"))}}componentDidMount(){this._timerId=self.setTimeout(this._checkStatus,0)}componentWillUnmount(){null!==this._timerId&&self.clearTimeout(this._timerId)}_renderResults(){const{guid:e}=this.props,t=Object.values(this.state.results);return i().createElement(S.Z,null,i().createElement(S.Z.Header,{className:"block__header"},(0,g.__)("Comparison Results","i8fjs")),i().createElement(S.Z.Body,null,"nofaces"===this.state.state&&i().createElement(S.Z.Text,{className:"text-danger"},(0,g.__)("Unfortunately, the system has failed to recognize any face, or the photo contains multiple faces","i8fjs")),i().createElement(x.Z,{className:"d-block text-center"},i().createElement(x.Z.Image,{className:"img-fluid",src:`https://api2.myrotvorets.center/identigraf-upload/v1/get/${e}/0`,alt:"",style:{maxHeight:"40vh"}}),i().createElement(x.Z.Caption,{className:"text-center fw-bold"},(0,g.__)("Compared photo","i8fjs"))),i().createElement(T.Z,{interval:null,fade:!0,style:{height:"45vh"}},t.map(this._renderPhoto))))}render(){const{error:e,state:t}=this.state;return"check"===t?i().createElement(o,null):e?i().createElement(u.Z,{variant:"danger"},e):this._renderResults()}}Z.contextType=p;class O extends a.Component{constructor(...e){super(...e),this.state={error:null,ctx:{token:""}},this._timerId=0,this.refreshToken=()=>{j.getApiToken().then((e=>{this.setState({ctx:{token:e},error:null}),this._timerId=self.setTimeout(this.refreshToken,3e5)})).catch((e=>{this.setState({error:e.message}),this._timerId=self.setTimeout(this.refreshToken,3e5)}))}}componentDidMount(){this.refreshToken()}componentWillUnmount(){this._timerId>0&&self.clearTimeout(this._timerId)}render(){const{ctx:e,error:t}=this.state;return i().createElement(c.Z,null,i().createElement(m.UT,null,i().createElement("h1",{className:"h2"},i().createElement(m.rU,{to:"/",className:"text-decoration-none"},self.i8f.title)),t&&i().createElement(u.Z,{variant:"danger"},t),e.token?i().createElement(p.Provider,{value:e},i().createElement(d.rs,null,i().createElement(d.AW,{path:"/compare/:guid",render:e=>i().createElement(Z,{guid:e.match.params.guid})}),i().createElement(d.AW,{path:"/",exact:!0},i().createElement(k,null)))):i().createElement(h.Z,{animation:"border",variant:"primary"})))}}(0,l.render)(i().createElement(i().StrictMode,null,i().createElement(O,null)),document.querySelector(".wrap"))},7363:e=>{e.exports=React},1533:e=>{e.exports=ReactDOM}},n={};e.m=r,t=[],e.O=(r,n,s,o)=>{if(!n){var a=1/0;for(u=0;u<t.length;u++){for(var[n,s,o]=t[u],i=!0,l=0;l<n.length;l++)(!1&o||a>=o)&&Object.keys(e.O).every((t=>e.O[t](n[l])))?n.splice(l--,1):(i=!1,o<a&&(a=o));if(i){t.splice(u--,1);var c=s();void 0!==c&&(r=c)}}return r}o=o||0;for(var u=t.length;u>0&&t[u-1][2]>o;u--)t[u]=t[u-1];t[u]=[n,s,o]},e.n=t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},e.d=(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e.j=888,(()=>{var t={888:0};e.O.j=e=>0===t[e];var r=(r,n)=>{var s,o,[a,i,l]=n,c=0;if(a.some((e=>0!==t[e]))){for(s in i)e.o(i,s)&&(e.m[s]=i[s]);if(l)var u=l(e)}for(r&&r(n);c<a.length;c++)e.o(t,o=a[c])&&t[o]&&t[o][0](),t[a[c]]=0;return e.O(u)},n=self.webpackChunk=self.webpackChunk||[];n.forEach(r.bind(null,0)),n.push=r.bind(null,n.push.bind(n))})();var s=e.O(void 0,[251],(()=>e(8486)));s=e.O(s)})();