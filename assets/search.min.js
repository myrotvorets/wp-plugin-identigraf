(()=>{function e(t){var n=a[t];if(void 0!==n)return n.exports;var s=a[t]={exports:{}};return r[t](s,s.exports,e),s.exports}var t,r={7836:(e,t,r)=>{function a(e){const t=x[e.code];return null!=t?t:e.message}function n({image:e}){return e&&e.length>0?m().createElement(F.Z,{src:e,alt:(0,y.__)("Face to search","i8fjs"),fluid:!0,className:"mb-3"}):null}function s({progress:e}){return null==e?null:m().createElement("div",{className:"d-flex align-items-center mb-3"},(0,y.__)("Upload:","i8fjs"),m().createElement(T.Z,{now:-1===e?100:e,striped:-1===e,animated:!0,className:"flex-fill mx-1"}),-1!==e?m().createElement("span",null,e.toFixed(2),"%"):void 0)}function i({minSimilarity:e,maxSimilarity:t,face:r}){return m().createElement("div",{className:"d-flex flex-column position-sticky bg-white",style:{top:"2rem"}},m().createElement("h4",{className:"d-sm-none"},(0,y.__)("Recognized face","i8fjs")),m().createElement("img",{className:"img-fluid mt-3 rounded",src:`data:image/jpeg;base64,${r}`,alt:""}),m().createElement("p",{"aria-label":"Similarity",className:"text-center"},(0,y.sprintf)((0,y.__)("%1$d…%2$d%%","i8fjs"),e,t)))}function o(){return m().createElement(O.Z,null,m().createElement(O.Z.Header,null,(0,y.__)("Processing the request","i8fjs")),m().createElement(O.Z.Body,null,m().createElement(O.Z.Title,null,(0,y.__)("Please wait…","i8fjs")),m().createElement(T.Z,{now:100,striped:!0,animated:!0})))}function l(){return l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},l.apply(this,arguments)}var c=r(7363),m=r.n(c),h=r(1533),u=r(754),d=r(1262),p=r(8662),f=r(4289),_=r(9635);const g=m().createContext({token:""});var E=r(2568),b=r(3738),v=r(7231),k=r(7137);const y=wp.i18n,j=wp.apiFetch;var S=r.n(j);const x={AUTHORIZATION_FAILED:(0,y.__)("Authorization failed.","i8fjs"),AUTHORIZATION_REQUIRED:(0,y.__)("Not authorized to perform this action.","i8fjs"),BAD_GATEWAY:(0,y.__)("Error communicating with the server.","i8fjs"),COMM_ERROR:(0,y.__)("Error communicating with the server.","i8fjs"),UNKNOWN_ERROR:(0,y.__)("Unknown error.","i8fjs")};class Z{static getApiToken(){return S()({path:"/identigraf/v2/token"}).then((e=>e.token)).catch((()=>{throw new Error((0,y.__)("Error getting the authentication token","i8fjs"))}))}static checkCompareStatus(e,t){return Z.get(`/compare/${e}`,t)}static checkSearchStatus(e,t){return Z.get(`/search/${e}`,t)}static getMatchedFaces(e,t,r){return Z.get(`/search/${e}/matches/${t}/0/20`,r)}static get(e,t){return Z.fetch(`${self.i8f.endpoint}${e}`,{headers:{Accept:"application/json",Authorization:`Bearer ${t}`}})}static fetch(e,t){return fetch(e,t).then((e=>e.json())).catch(Z.error502)}static error502(){return{success:!1,status:502,code:"COMM_ERROR",message:(0,y.__)("Error communicating with the server","i8fjs")}}}var F=r(3169),T=r(6364);class w extends c.Component{constructor(...e){super(...e),this.state={image:"",uploadProgress:null,error:null,guid:null},this._onFileChange=({currentTarget:e})=>{this.setState({error:null});const{files:t}=e,r=null==t?void 0:t[0];if(null!=r&&r.type.startsWith("image/")){const e=new FileReader;e.addEventListener("load",(({target:e})=>{this.setState({image:e.result})})),e.readAsDataURL(r)}else this.setState({image:""})},this._onFormSubmit=e=>{e.preventDefault();const t=new FormData(e.currentTarget);this.setState({uploadProgress:0,error:null});const r=this.context.token,a=new XMLHttpRequest;a.upload.addEventListener("progress",this._onUploadProgress),a.addEventListener("error",this._onUploadFailed),a.addEventListener("abort",this._onUploadAborted),a.addEventListener("timeout",this._onUploadTimeout),a.addEventListener("load",this._onUploadSucceeded),a.open("POST",`${self.i8f.endpoint}/search`),a.setRequestHeader("Authorization",`Bearer ${r}`),a.send(t)},this._onUploadProgress=e=>{this.setState({uploadProgress:e.lengthComputable?e.loaded/e.total*100:-1})},this._onUploadFailed=()=>{this._setError((0,y.__)("Failed to upload the file","i8fjs"))},this._onUploadTimeout=()=>{this._setError((0,y.__)("Request has timed out","i8fjs"))},this._onUploadAborted=()=>{this._setError((0,y.__)("Upload aborted","i8fjs"))},this._onUploadSucceeded=e=>{this.setState({uploadProgress:100});const t=e.currentTarget;try{const e=JSON.parse(t.responseText);e.success?this.setState({guid:e.guid}):this._setError(401===t.status?(0,y.__)("Unexpected authentication error","i8fjs"):a(e))}catch(e){this._setError((0,y.__)("Unknown error while analyzing the server response","i8fjs"))}}}_setError(e){this.setState({uploadProgress:null,error:e})}render(){const{error:e,guid:t,image:r,uploadProgress:a}=this.state;return null!==t?m().createElement(_.l_,{to:`/search/${t}`}):m().createElement(E.Z,{encType:"multipart/form-data",onSubmit:this._onFormSubmit},e&&m().createElement(d.Z,{variant:"danger"},e),m().createElement(E.Z.Group,{controlId:"photo",className:"mb-3"},m().createElement(E.Z.Label,null,(0,y.__)("Photo","i8fjs")),m().createElement(E.Z.Control,{name:"photo",type:"file",required:!0,accept:"image/png, image/jpeg",disabled:null!==a,onChange:this._onFileChange})),m().createElement(b.Z,null,m().createElement(v.Z,null,m().createElement(n,{image:r}))),m().createElement(s,{progress:a}),m().createElement(k.Z,{variant:"primary",type:"submit"},(0,y.__)("Submit","i8fjs")))}}w.contextType=g;var C=r(2363),O=r(1325),N=r(3272);class U extends c.Component{constructor(...e){super(...e),this._onLinkClicked=e=>{const{onClick:t}=this.props;t&&(e.preventDefault(),t(e.currentTarget.href))}}render(){const{country:e,face:t,link:r,matchedPhoto:a,name:n,primaryPhoto:s,similarity:i}=this.props;return m().createElement(m().Fragment,null,m().createElement("a",{href:r?r.replace("https://myrotvorets.center",self.i8f.baseurl):"#",target:"_blank",rel:"noopener noreferrer",className:"text-danger fw-bold text-decoration-none fs-3"},n||(0,y.__)("Unknown person","i8fjs")),m().createElement("img",{src:`data:image/jpeg;base64,${t}`,className:"img-fluid img-thumbnail d-block mb-2",alt:(0,y.__)("Face","i8fjs")}),e&&m().createElement("p",{className:"mb-1"},(0,y.sprintf)((0,y.__)("Country: %s","i8fjs"),e)),a&&m().createElement("p",{className:"mb-1"},m().createElement("a",{href:a,target:"_blank",rel:"noopener noreferrer",onClick:this._onLinkClicked},(0,y.__)("Matched photo","i8fjs"))),s&&m().createElement("p",{className:"mb-1"},m().createElement("a",{href:s,target:"_blank",rel:"noopener noreferrer",onClick:this._onLinkClicked},(0,y.__)("Primary photo","i8fjs"))),m().createElement("p",{className:"mb-1"},(0,y.sprintf)((0,y.__)("Similarity: %1$d%%","i8fjs"),i)))}}class R extends c.Component{constructor(...e){super(...e),this.state={state:"check",error:"",capturedFaces:[],matchedFaces:[],lightbox:null},this._timerId=0,this._onFaceLinkClicked=e=>{this.setState({lightbox:e})},this._onLightboxCloseRequest=()=>{this.setState({lightbox:null})},this._checkStatus=()=>{this._timerId=0;const{guid:e}=this.props;Z.checkSearchStatus(e,this.context.token).then((e=>(e.success?"inprogress"===e.status?this._timerId=self.setTimeout(this._checkStatus,2e3):this.setState({capturedFaces:e.faces},(()=>this._getMatchedFaces())):this.setState({state:"done",error:a(e)}),null)))},this._renderMatchedFace=(e,t)=>m().createElement(C.Z.Item,{key:t},m().createElement(U,l({},e,{onClick:this._onFaceLinkClicked}))),this._renderCapturedFace=(e,t)=>m().createElement(C.Z.Item,{key:e.faceID},m().createElement(b.Z,null,m().createElement(v.Z,null,m().createElement("strong",{className:"fs-2"},(0,y.sprintf)((0,y.__)("Face %d","i8fjs"),t+1)))),m().createElement(b.Z,null,m().createElement(v.Z,{md:2,className:"position-sticky bg-white",style:{zIndex:1e3,top:0}},m().createElement(i,e)),m().createElement(v.Z,null,this._renderMatchedFaces(e.faceID,t))))}componentDidMount(){this._timerId=self.setTimeout(this._checkStatus,0)}componentWillUnmount(){0!==this._timerId&&self.clearTimeout(this._timerId)}_addMatches(e){this.setState((t=>({matchedFaces:[...t.matchedFaces,e]})))}_getMatchedFaces(){const{guid:e}=this.props,{capturedFaces:t}=this.state;Promise.all(t.map((({faceID:t})=>Z.getMatchedFaces(e,t,this.context.token)))).then((e=>(e.forEach((e=>this._addMatches(e.success?e.matches:null))),this.setState({state:"done"})))).catch((e=>console.error(e)))}_renderMatchedFaces(e,t){const{matchedFaces:r}=this.state,a=r[t];return void 0===a?m().createElement(O.Z.Body,null,m().createElement(p.Z,{animation:"border",variant:"primary"},m().createElement("span",{className:"visually-hidden"},(0,y.__)("Loading…","i8fjs")))):null===a?m().createElement(O.Z.Body,null,m().createElement(d.Z,{variant:"danger"},(0,y.__)("Error loading captured faces","i8fjs")),";"):m().createElement(C.Z,{variant:"flush"},a.map(this._renderMatchedFace))}render(){const{capturedFaces:e,error:t,lightbox:r,state:a}=this.state;return"check"===a?m().createElement(o,null):t?m().createElement(d.Z,{variant:"danger"},t):m().createElement(m().Fragment,null,m().createElement(O.Z,null,m().createElement(O.Z.Header,{className:e.length?"bg-primary text-white":"bg-danger text-white"},(0,y.__)("Search Results","i8fjs")),e.length?m().createElement(C.Z,{variant:"flush"},e.map(this._renderCapturedFace)):m().createElement(O.Z.Body,null,m().createElement(O.Z.Text,null,(0,y.__)("Unfortunately, the system has failed to recognize any face on the photo.","i8fjs")))),r&&m().createElement(N.Z,{mainSrc:r,onCloseRequest:this._onLightboxCloseRequest}))}}R.contextType=g;class I extends c.Component{constructor(...e){super(...e),this.state={error:null,ctx:{token:""}},this._timerId=0,this.refreshToken=()=>{Z.getApiToken().then((e=>{this.setState({ctx:{token:e},error:null}),this._timerId=self.setTimeout(this.refreshToken,3e5)})).catch((e=>{this.setState({error:e.message}),this._timerId=self.setTimeout(this.refreshToken,3e5)}))}}componentDidMount(){this.refreshToken()}componentWillUnmount(){this._timerId>0&&self.clearTimeout(this._timerId)}render(){const{ctx:e,error:t}=this.state;return m().createElement(u.Z,null,m().createElement(f.UT,null,m().createElement("h1",{className:"h2"},m().createElement(f.rU,{to:"/",className:"text-decoration-none"},self.i8f.title)),t&&m().createElement(d.Z,{variant:"danger"},t),e.token?m().createElement(g.Provider,{value:e},m().createElement(_.rs,null,m().createElement(_.AW,{path:"/search/:guid",render:e=>m().createElement(R,{guid:e.match.params.guid})}),m().createElement(_.AW,{path:"/",exact:!0},m().createElement(w,null)))):m().createElement(p.Z,{animation:"border",variant:"primary"})))}}(0,h.render)(m().createElement(m().StrictMode,null,m().createElement(I,null)),document.querySelector(".wrap"))},7363:e=>{e.exports=React},1533:e=>{e.exports=ReactDOM}},a={};e.m=r,t=[],e.O=(r,a,n,s)=>{if(!a){var i=1/0;for(m=0;m<t.length;m++){for(var[a,n,s]=t[m],o=!0,l=0;l<a.length;l++)(!1&s||i>=s)&&Object.keys(e.O).every((t=>e.O[t](a[l])))?a.splice(l--,1):(o=!1,s<i&&(i=s));if(o){t.splice(m--,1);var c=n();void 0!==c&&(r=c)}}return r}s=s||0;for(var m=t.length;m>0&&t[m-1][2]>s;m--)t[m]=t[m-1];t[m]=[a,n,s]},e.n=t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},e.d=(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})},e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e.j=464,(()=>{var t={464:0};e.O.j=e=>0===t[e];var r=(r,a)=>{var n,s,[i,o,l]=a,c=0;if(i.some((e=>0!==t[e]))){for(n in o)e.o(o,n)&&(e.m[n]=o[n]);if(l)var m=l(e)}for(r&&r(a);c<i.length;c++)e.o(t,s=i[c])&&t[s]&&t[s][0](),t[i[c]]=0;return e.O(m)},a=self.webpackChunk=self.webpackChunk||[];a.forEach(r.bind(null,0)),a.push=r.bind(null,a.push.bind(a))})();var n=e.O(void 0,[251],(()=>e(7836)));n=e.O(n)})();