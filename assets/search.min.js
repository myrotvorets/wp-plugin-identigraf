(()=>{function e(t){var a=n[t];if(void 0!==a)return a.exports;var s=n[t]={exports:{}};return r[t](s,s.exports,e),s.exports}var t,r={3813:(e,t,r)=>{function n(e){const t=F[e.code];return null!=t?t:e.message}function a({image:e}){return e&&e.length>0?u().createElement(w.Z,{src:e,alt:(0,x.__)("Face to search","i8fjs"),fluid:!0,className:"mb-3"}):null}function s({progress:e}){return null==e?null:u().createElement("div",{className:"d-flex align-items-center mb-3"},(0,x.__)("Upload:","i8fjs"),u().createElement(C.Z,{now:-1===e?100:e,striped:-1===e,animated:!0,className:"flex-fill mx-1"}),-1!==e?u().createElement("span",null,e.toFixed(2),"%"):void 0)}function i({minSimilarity:e,maxSimilarity:t,face:r}){return u().createElement("div",{className:"d-flex flex-column position-sticky bg-white",style:{top:"2rem"}},u().createElement("h4",{className:"d-sm-none"},(0,x.__)("Recognized face","i8fjs")),u().createElement("img",{className:"img-fluid mt-3 rounded",src:`data:image/jpeg;base64,${r}`,alt:""}),u().createElement("p",{"aria-label":"Similarity",className:"text-center"},(0,x.sprintf)((0,x.__)("%1$d…%2$d%%","i8fjs"),e,t)))}function l(){return u().createElement(U.Z,null,u().createElement(U.Z.Header,null,(0,x.__)("Processing the request","i8fjs")),u().createElement(U.Z.Body,null,u().createElement(U.Z.Title,null,(0,x.__)("Please wait…","i8fjs")),u().createElement(C.Z,{now:100,striped:!0,animated:!0})))}function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},o.apply(this,arguments)}function c(){const{guid:e}=(0,_.UO)();return u().createElement(L,{guid:e})}var m=r(7363),u=r.n(m),h=r(7634),d=r(9079),p=r(754),f=r(8662),_=r(4935),g=r(5783);const E=(0,m.createContext)({token:""});var b=r(7137),v=r(7231),y=r(1840),k=r(2290),j=r(3738);const x=wp.i18n,S=wp.apiFetch;var Z=r.n(S);const F={AUTHORIZATION_FAILED:(0,x.__)("Authorization failed.","i8fjs"),AUTHORIZATION_REQUIRED:(0,x.__)("Not authorized to perform this action.","i8fjs"),BAD_GATEWAY:(0,x.__)("Error communicating with the server.","i8fjs"),COMM_ERROR:(0,x.__)("Error communicating with the server.","i8fjs"),UNKNOWN_ERROR:(0,x.__)("Unknown error.","i8fjs")};class T{static getApiToken(){return Z()({path:"/identigraf/v2/token"}).then((e=>e.token)).catch((()=>{throw new Error((0,x.__)("Error getting the authentication token","i8fjs"))}))}static checkCompareStatus(e,t){return T.get(`/compare/${e}`,t)}static checkSearchStatus(e,t){return T.get(`/search/${e}`,t)}static getMatchedFaces(e,t,r){return T.get(`/search/${e}/matches/${t}/0/20`,r)}static get(e,t){return T.fetch(`${self.i8f.iendpoint}${e}`,{headers:{Accept:"application/json",Authorization:`Bearer ${t}`}})}static fetch(e,t){return fetch(e,t).then((e=>e.json())).catch(T.error502)}static error502(){return{success:!1,status:502,code:"COMM_ERROR",message:(0,x.__)("Error communicating with the server","i8fjs")}}}var w=r(3169),C=r(6364);class O extends m.Component{constructor(...e){super(...e),this.state={image:"",uploadProgress:null,error:null,guid:null,minSimilarity:30},this._onFileChange=({currentTarget:e})=>{this.setState({error:null});const{files:t}=e,r=null==t?void 0:t[0];if(null!=r&&r.type.startsWith("image/")){const e=new FileReader;e.addEventListener("load",(({target:e})=>{this.setState({image:e.result})})),e.readAsDataURL(r)}else this.setState({image:""})},this._onFormSubmit=e=>{e.preventDefault();const t=new FormData(e.currentTarget);this.setState({uploadProgress:0,error:null});const r=this.context.token,n=new XMLHttpRequest;n.upload.addEventListener("progress",this._onUploadProgress),n.addEventListener("error",this._onUploadFailed),n.addEventListener("abort",this._onUploadAborted),n.addEventListener("timeout",this._onUploadTimeout),n.addEventListener("load",this._onUploadSucceeded),n.open("POST",`${self.i8f.iendpoint}/search`),n.setRequestHeader("Authorization",`Bearer ${r}`),n.send(t)},this._onSimilarityChange=({currentTarget:e})=>{this.setState({minSimilarity:e.valueAsNumber})},this._onUploadProgress=e=>{this.setState({uploadProgress:e.lengthComputable?e.loaded/e.total*100:-1})},this._onUploadFailed=()=>{this._setError((0,x.__)("Failed to upload the file","i8fjs"))},this._onUploadTimeout=()=>{this._setError((0,x.__)("Request has timed out","i8fjs"))},this._onUploadAborted=()=>{this._setError((0,x.__)("Upload aborted","i8fjs"))},this._onUploadSucceeded=e=>{this.setState({uploadProgress:100});const t=e.currentTarget;try{const e=JSON.parse(t.responseText);e.success?this.setState({guid:e.guid}):this._setError(401===t.status?(0,x.__)("Unexpected authentication error","i8fjs"):n(e))}catch(e){this._setError((0,x.__)("Unknown error while analyzing the server response","i8fjs"))}}}_setError(e){this.setState({uploadProgress:null,error:e})}render(){const{error:e,guid:t,image:r,minSimilarity:n,uploadProgress:i}=this.state;return null!==t?u().createElement(_.Fg,{to:`/search/${t}`}):u().createElement(y.Z,{encType:"multipart/form-data",onSubmit:this._onFormSubmit},e&&u().createElement(d.Z,{variant:"danger"},e),u().createElement(y.Z.Group,{controlId:"photo",className:"mb-3"},u().createElement(y.Z.Label,null,(0,x.__)("Photo:","i8fjs")),u().createElement(y.Z.Control,{name:"photo",type:"file",required:!0,accept:"image/png, image/jpeg",disabled:null!==i,onChange:this._onFileChange})),u().createElement(y.Z.Group,{controlId:"minSimilarity",className:"mb-3"},u().createElement(y.Z.Label,null,(0,x.__)("Minimum similarity","i8fjs")),u().createElement(k.Z,null,u().createElement(y.Z.Control,{name:"minSimilarity",type:"number",min:"10",max:"100",step:"1",value:n,onInput:this._onSimilarityChange,required:!0}),u().createElement(k.Z.Text,null,"%"))),u().createElement(j.Z,null,u().createElement(v.Z,null,u().createElement(a,{image:r}))),u().createElement(s,{progress:i}),u().createElement(b.Z,{variant:"primary",type:"submit"},(0,x.__)("Submit","i8fjs")))}}O.contextType=E;var U=r(4048),I=r(4007),N=r(5263),M=r(3364);const R=({children:e})=>e?u().createElement("p",{className:"mb-1"},e):null,P=({link:e,text:t,onClick:r})=>{if(e){const n=e=>{e.preventDefault(),r(e.currentTarget.href)};return u().createElement(R,null,u().createElement("a",{href:e,target:"_blank",rel:"noopener noreferrer",onClick:n},t))}return null};class A extends m.Component{render(){const{country:e,face:t,link:r,matchedPhoto:n,name:a,onClick:s,primaryPhoto:i,similarity:l}=this.props;return u().createElement(u().Fragment,null,u().createElement("a",{href:r?r.replace("https://myrotvorets.center",self.i8f.baseurl):"#",target:"_blank",rel:"noopener noreferrer",className:"text-danger fw-bold text-decoration-none fs-3"},a||(0,x.__)("Unknown person","i8fjs")),u().createElement("img",{src:`data:image/jpeg;base64,${t}`,className:"img-fluid img-thumbnail d-block mb-2",alt:(0,x.__)("Face","i8fjs")}),e&&u().createElement(R,null,(0,x.sprintf)((0,x.__)("Country: %s","i8fjs"),e)),u().createElement(P,{link:n,text:(0,x.__)("Matched photo","i8fjs"),onClick:s}),u().createElement(P,{link:i,text:(0,x.__)("Primary photo","i8fjs"),onClick:s}),u().createElement(R,null,(0,x.sprintf)((0,x.__)("Similarity: %1$d%%","i8fjs"),l)))}}class L extends m.Component{constructor(...e){super(...e),this.state={state:"check",error:"",capturedFaces:[],matchedFaces:[],lightbox:null},this._timerId=0,this._onFaceLinkClicked=e=>{this.setState({lightbox:e})},this._onLightboxClose=()=>{this.setState({lightbox:null})},this._checkStatus=()=>{this._timerId=0;const{guid:e}=this.props;T.checkSearchStatus(e,this.context.token).then((e=>(e.success?"inprogress"===e.status?this._timerId=self.setTimeout(this._checkStatus,2e3):this.setState({capturedFaces:e.faces},(()=>this._getMatchedFaces())):this.setState({state:"done",error:n(e)}),null)))},this._renderMatchedFace=(e,t)=>u().createElement(I.Z.Item,{key:t},u().createElement(A,o({},e,{onClick:this._onFaceLinkClicked}))),this._renderCapturedFace=(e,t)=>u().createElement(I.Z.Item,{key:e.faceID},u().createElement(j.Z,null,u().createElement(v.Z,null,u().createElement("strong",{className:"fs-2"},(0,x.sprintf)((0,x.__)("Face %d","i8fjs"),t+1)))),u().createElement(j.Z,null,u().createElement(v.Z,{md:2,className:"position-sticky bg-white",style:{zIndex:1e3,top:0}},u().createElement(i,e)),u().createElement(v.Z,null,this._renderMatchedFaces(e.faceID,t))))}componentDidMount(){this._timerId=self.setTimeout(this._checkStatus,0)}componentWillUnmount(){0!==this._timerId&&self.clearTimeout(this._timerId)}_addMatches(e){this.setState((t=>({matchedFaces:[...t.matchedFaces,e]})))}_getMatchedFaces(){const{guid:e}=this.props,{capturedFaces:t}=this.state;Promise.all(t.map((({faceID:t})=>T.getMatchedFaces(e,t,this.context.token)))).then((e=>(e.forEach((e=>this._addMatches(e.success?e.matches:null))),this.setState({state:"done"})))).catch((e=>console.error(e)))}_renderMatchedFaces(e,t){const{matchedFaces:r}=this.state,n=r[t];return void 0===n?u().createElement(U.Z.Body,null,u().createElement(f.Z,{animation:"border",variant:"primary"},u().createElement("span",{className:"visually-hidden"},(0,x.__)("Loading…","i8fjs")))):null===n?u().createElement(U.Z.Body,null,u().createElement(d.Z,{variant:"danger"},(0,x.__)("Error loading captured faces","i8fjs")),";"):u().createElement(I.Z,{variant:"flush"},n.map(this._renderMatchedFace))}render(){const{capturedFaces:e,error:t,lightbox:r,state:n}=this.state;return"check"===n?u().createElement(l,null):t?u().createElement(d.Z,{variant:"danger"},t):u().createElement(u().Fragment,null,u().createElement(U.Z,null,u().createElement(U.Z.Header,{className:e.length?"bg-primary text-white":"bg-danger text-white"},(0,x.__)("Search Results","i8fjs")),e.length?u().createElement(I.Z,{variant:"flush"},e.map(this._renderCapturedFace)):u().createElement(U.Z.Body,null,u().createElement(U.Z.Text,null,(0,x.__)("Unfortunately, the system has failed to recognize any face on the photo.","i8fjs")))),r&&u().createElement(N.ZP,{open:null!==r,close:this._onLightboxClose,slides:[{src:r}],fullscreen:{auto:!1},plugins:[M.Z]}))}}L.contextType=E;class $ extends m.Component{constructor(...e){super(...e),this.state={error:null,ctx:{token:""}},this._timerId=0,this.refreshToken=()=>{T.getApiToken().then((e=>{this.setState({ctx:{token:e},error:null}),this._timerId=self.setTimeout(this.refreshToken,3e5)})).catch((e=>{this.setState({error:e.message}),this._timerId=self.setTimeout(this.refreshToken,3e5)}))}}componentDidMount(){this.refreshToken()}componentWillUnmount(){this._timerId>0&&self.clearTimeout(this._timerId)}render(){const{ctx:e,error:t}=this.state;return u().createElement(p.Z,null,u().createElement(g.UT,null,u().createElement("h1",{className:"h2"},u().createElement(g.rU,{to:"/",className:"text-decoration-none"},self.i8f.title)),t&&u().createElement(d.Z,{variant:"danger"},t),e.token?u().createElement(E.Provider,{value:e},u().createElement(_.Z5,null,u().createElement(_.AW,{path:"/search/:guid",element:u().createElement(c,null)}),u().createElement(_.AW,{path:"/",element:u().createElement(O,null)}))):u().createElement(f.Z,{animation:"border",variant:"primary"})))}}const D=document.querySelector(".wrap");(0,h.s)(null!=D?D:document.body).render(u().createElement(u().StrictMode,null,u().createElement($,null)))},7363:e=>{e.exports=React},1533:e=>{e.exports=ReactDOM}},n={};e.m=r,t=[],e.O=(r,n,a,s)=>{if(!n){var i=1/0;for(m=0;m<t.length;m++){for(var[n,a,s]=t[m],l=!0,o=0;o<n.length;o++)(!1&s||i>=s)&&Object.keys(e.O).every((t=>e.O[t](n[o])))?n.splice(o--,1):(l=!1,s<i&&(i=s));if(l){t.splice(m--,1);var c=a();void 0!==c&&(r=c)}}return r}s=s||0;for(var m=t.length;m>0&&t[m-1][2]>s;m--)t[m]=t[m-1];t[m]=[n,a,s]},e.n=t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},e.d=(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e.j=464,(()=>{var t={464:0};e.O.j=e=>0===t[e];var r=(r,n)=>{var a,s,[i,l,o]=n,c=0;if(i.some((e=>0!==t[e]))){for(a in l)e.o(l,a)&&(e.m[a]=l[a]);if(o)var m=o(e)}for(r&&r(n);c<i.length;c++)e.o(t,s=i[c])&&t[s]&&t[s][0](),t[s]=0;return e.O(m)},n=self.webpackChunk=self.webpackChunk||[];n.forEach(r.bind(null,0)),n.push=r.bind(null,n.push.bind(n))})();var a=e.O(void 0,[251],(()=>e(3813)));a=e.O(a)})();